{% load static %}
{% block content %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Messages — Don Sang Plus</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary-red: #ef4444;
      --bg: #f8fafc;
      --muted: #6b7280;
      --white: #ffffff;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
    .chat-container{display:flex;height:100vh}
    .modern-sidebar{width:280px;background:var(--white);border-right:1px solid #e5e7eb;display:flex;flex-direction:column}
    .sidebar-logo{padding:16px;font-weight:700;display:flex;align-items:center;gap:8px}
    .sidebar-nav{flex:1;padding:8px}
    .sidebar-nav a{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;color:var(--muted);text-decoration:none}
    .sidebar-nav a.active{background:linear-gradient(135deg,var(--primary-red),#dc2626);color:var(--white)}
    .chat-main{flex:1;display:flex;flex-direction:column}
    .chat-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:var(--white)}
    .chat-messages{flex:1;overflow-y:auto;padding:24px;background:linear-gradient(180deg,#fff,#f8fafc)}
    .message-date-divider{display:flex;justify-content:center;margin:16px 0;color:var(--muted);font-size:13px}
    .message-item{display:flex;gap:12px;margin-bottom:12px;align-items:flex-end}
    .message-item.sent{justify-content:flex-end}
    .message-bubble{max-width:60%;padding:12px 14px;border-radius:12px;background:var(--white);box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .message-item.sent .message-bubble{background:linear-gradient(135deg,var(--primary-red),#dc2626);color:#fff}
    .chat-input-area{padding:12px 16px;border-top:1px solid #e5e7eb;background:var(--white);display:flex;gap:12px;align-items:center}
    .chat-input{flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;min-height:44px;resize:none}
    .send-btn{background:linear-gradient(135deg,var(--primary-red),#dc2626);border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>
  <div class="chat-container">
    {% if user.user_type == 'donor' %}
      {% include 'includes/donor_sidebar.html' with active_page='messages' %}
    {% else %}
      {% include 'includes/hospital_sidebar.html' with active_page='messages' %}
    {% endif %}

    <main class="chat-main">
      <div class="chat-header">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:44px;height:44px;border-radius:44px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700">{{ other_user.first_name.0|default:'U' }}</div>
          <div>
            <div style="font-weight:700">{{ other_user.get_full_name }}</div>
            <div style="font-size:13px;color:var(--muted)">{% if response %}{{ response.blood_request.blood_type }} • {{ response.get_status_display }}{% endif %}</div>
          </div>
        </div>
        <div>
          <a href="{% if user.user_type == 'donor' %}{% url 'donations:donor_messages' %}{% else %}{% url 'donations:hospital_messages' %}{% endif %}" style="text-decoration:none;color:var(--muted)"><i class="fas fa-arrow-left"></i> Retour</a>
        </div>
      </div>

      <div class="chat-messages" id="messagesContainer">
        {% if messages_list %}
          {% regroup messages_list by timestamp|date:"Y-m-d" as messages_by_date %}
          {% for date_group in messages_by_date %}
            <div class="message-date-divider">{{ date_group.grouper|date:"d F Y" }}</div>
            {% for message in date_group.list %}
              <div class="message-item {% if message.sender == user %}sent{% endif %}">
                {% if not message.sender == user %}
                  <div style="width:36px;height:36px;border-radius:36px;background:#fff;display:flex;align-items:center;justify-content:center">{{ message.sender.first_name.0|default:'U' }}</div>
                {% endif %}
                <div class="message-bubble">{{ message.message }}</div>
                {% if message.sender == user %}
                  <div style="width:36px;height:36px;border-radius:36px;display:flex;align-items:center;justify-content:center;color:var(--muted)">{{ user.first_name.0|default:'M' }}</div>
                {% endif %}
              </div>
            {% endfor %}
          {% endfor %}
        {% else %}
          <div style="padding:60px;text-align:center;color:var(--muted)">
            <i class="fas fa-comments" style="font-size:48px;margin-bottom:12px;display:block"></i>
            <div style="font-size:18px;font-weight:600">Aucun message pour le moment</div>
            <div style="margin-top:8px;color:var(--muted)">Commencez la conversation en envoyant un message</div>
          </div>
        {% endif %}
      </div>

      <div class="chat-input-area">
        <form method="post" id="messageForm">
          {% csrf_token %}
          <textarea id="messageInput" name="message" class="chat-input" rows="1" placeholder="Tapez votre message..." required></textarea>
          <button type="submit" class="send-btn"><i class="fas fa-paper-plane"></i></button>
        </form>
      </div>

    </main>
  </div>

  <script>
    // Auto-scroll to bottom on load
    window.addEventListener('load', function(){
      const el = document.getElementById('messagesContainer');
      if(el) el.scrollTop = el.scrollHeight;
    });

    // Auto-resize textarea
    const textarea = document.getElementById('messageInput');
    if(textarea){
      textarea.addEventListener('input', function(){
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 180) + 'px';
      });

      textarea.addEventListener('keydown', function(e){
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          document.getElementById('messageForm').submit();
        }
      });
    }

    // Keep scroll at bottom after submit
    const form = document.getElementById('messageForm');
    if(form){
      form.addEventListener('submit', function(){
        setTimeout(()=>{const el=document.getElementById('messagesContainer'); if(el) el.scrollTop = el.scrollHeight}, 100);
      });
    }
  </script>
</body>
</html>
{% endblock %}
