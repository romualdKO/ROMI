<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - Don Sang Plus</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/modern-design.css' %}">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()" aria-label="Menu">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="modern-sidebar" id="mobileSidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon">
                <i class="fas fa-heart-pulse"></i>
            </div>
            <div class="sidebar-logo-text">Don Sang Plus</div>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'donations:donor_dashboard' %}" class="sidebar-nav-item">
                <i class="fas fa-home sidebar-nav-icon"></i>
                Dashboard
            </a>
            <a href="{% url 'donations:donor_dashboard' %}#requests-section" class="sidebar-nav-item">
                <i class="fas fa-heart sidebar-nav-icon"></i>
                Demandes
            </a>
            <a href="{% url 'donations:donor_messages' %}" class="sidebar-nav-item">
                <i class="fas fa-envelope sidebar-nav-icon"></i>
                Messages
            </a>
            <a href="{% url 'donations:donor_history' %}" class="sidebar-nav-item active">
                <i class="fas fa-history sidebar-nav-icon"></i>
                Historique
            </a>
            <a href="{% url 'donations:my_rewards' %}" class="sidebar-nav-item">
                <i class="fas fa-trophy sidebar-nav-icon"></i>
                Mes Avantages
            </a>
            <a href="{% url 'donations:update_availability' %}" class="sidebar-nav-item">
                <i class="fas fa-calendar-check sidebar-nav-icon"></i>
                Disponibilité
            </a>
            <a href="{% url 'donations:edit_profile' %}" class="sidebar-nav-item">
                <i class="fas fa-user-edit sidebar-nav-icon"></i>
                Profil
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{% url 'accounts:logout' %}" class="sidebar-nav-item" style="color: var(--danger-red);">
                <i class="fas fa-sign-out-alt sidebar-nav-icon"></i>
                Déconnexion
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="modern-main-content">
        <div class="modern-topbar">
            <div>
                <div class="topbar-title">
                    <i class="fas fa-history"></i> Historique
                </div>
                <div class="topbar-subtitle">{{ stats.total }} réponse(s) • {{ stats.completed }} don(s) complété(s)</div>
            </div>
            <div class="topbar-actions">
                <a href="{% url 'donations:donor_dashboard' %}" class="btn-modern btn-modern-secondary" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; font-weight: 600; transition: all 0.3s ease; margin-right: 1rem;">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
                
                <a href="{% url 'donations:edit_profile' %}" class="topbar-user" style="text-decoration: none; color: inherit; transition: transform 0.2s ease;">
                    <div class="user-avatar">
                        {{ user.first_name.0|default:"U" }}{{ user.last_name.0|default:"" }}
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                        <div class="user-role">Donneur</div>
                    </div>
                </a>
            </div>
        </div>

        <div class="container-modern">
            <!-- Statistics -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-card green">
                    <div class="stat-card-header">
                        <div><div class="stat-card-title">Complétés</div></div>
                        <div class="stat-card-icon"><i class="fas fa-check-circle"></i></div>
                    </div>
                    <div class="stat-card-value">{{ stats.completed }}</div>
                </div>
                
                <div class="stat-card blue">
                    <div class="stat-card-header">
                        <div><div class="stat-card-title">Acceptés</div></div>
                        <div class="stat-card-icon"><i class="fas fa-thumbs-up"></i></div>
                    </div>
                    <div class="stat-card-value">{{ stats.accepted }}</div>
                </div>
                
                <div class="stat-card yellow">
                    <div class="stat-card-header">
                        <div><div class="stat-card-title">En attente</div></div>
                        <div class="stat-card-icon"><i class="fas fa-clock"></i></div>
                    </div>
                    <div class="stat-card-value">{{ stats.pending }}</div>
                </div>
                
                <div class="stat-card red">
                    <div class="stat-card-header">
                        <div><div class="stat-card-title">Annulés</div></div>
                        <div class="stat-card-icon"><i class="fas fa-times-circle"></i></div>
                    </div>
                    <div class="stat-card-value">{{ stats.cancelled }}</div>
                </div>
            </div>

            <!-- Donations Completed -->
            {% if completed_donations %}
            <div class="card-modern" style="margin-bottom: 24px;">
                <div class="card-modern-header">
                    <h3 class="card-modern-title">
                        <i class="fas fa-trophy"></i>
                        Dons Complétés
                    </h3>
                    <span class="badge-modern success">{{ completed_donations.count }}</span>
                </div>
                <div class="card-modern-body">
                    <div class="modern-table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Hôpital</th>
                                    <th>Groupe Sanguin</th>
                                    <th>Quantité</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for donation in completed_donations %}
                                <tr style="cursor: pointer;" data-href="{% url 'donations:request_detail' donation.blood_request.id %}" onclick="window.location.href=this.dataset.href">
                                    <td>{{ donation.donation_date|date:"d/m/Y" }}</td>
                                    <td>
                                        <div style="font-weight: 600;">{{ donation.blood_request.hospital.hospital_name }}</div>
                                        <small style="color: var(--text-gray);">{{ donation.blood_request.hospital.city }}</small>
                                    </td>
                                    <td>
                                        <span class="badge-modern danger">
                                            <i class="fas fa-tint"></i> {{ donation.blood_request.blood_type }}
                                        </span>
                                    </td>
                                    <td><strong>{{ donation.blood_request.quantity }}</strong> poche(s)</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- All Responses -->
            <div class="card-modern">
                <div class="card-modern-header">
                    <h3 class="card-modern-title">
                        <i class="fas fa-list"></i>
                        Toutes les réponses
                    </h3>
                    <span class="badge-modern info">{{ stats.total }}</span>
                </div>
                <div class="card-modern-body">
                    {% if all_responses %}
                        <div class="modern-table-container">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Hôpital</th>
                                        <th>Groupe</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for response in all_responses %}
                                    <tr style="cursor: pointer;" data-href="{% url 'donations:request_detail' response.blood_request.id %}" onclick="window.location.href=this.dataset.href">
                                        <td>{{ response.response_date|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            <div style="font-weight: 600;">{{ response.blood_request.hospital.hospital_name }}</div>
                                            <small style="color: var(--text-gray);">{{ response.blood_request.hospital.city }}</small>
                                        </td>
                                        <td>
                                            <span class="badge-modern danger">
                                                {{ response.blood_request.blood_type }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if response.status == 'pending' %}
                                                <span class="badge-modern warning">En attente</span>
                                            {% elif response.status == 'accepted' %}
                                                <span class="badge-modern success">Accepté</span>
                                            {% elif response.status == 'completed' %}
                                                <span class="badge-modern info">Complété</span>
                                            {% elif response.status == 'cancelled' %}
                                                <span class="badge-modern danger">Annulé</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-gray);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <div style="font-size: 16px;">Aucune réponse pour le moment</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/mobile-menu.js' %}"></script>
</body>
</html>
