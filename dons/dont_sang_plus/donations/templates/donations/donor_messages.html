{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Don de Sang+</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern-design.css' %}">
    <link rel="stylesheet" href="{% static 'css/soft-ui-enhancements.css' %}">
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <script src="{% static 'js/mobile-menu.js' %}"></script>
</head>
<body class="messages-page">
    <div class="dashboard-wrapper">
        {% include 'includes/donor_sidebar.html' with active_page='messages' %}
        <div class="messages-container">
            <!-- Sidebar des conversations -->
            <div class="conversations-sidebar">
                <div class="sidebar-header">
                    <h2>Messages</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Rechercher une conversation...">
                    </div>
                </div>
                <div class="conversations-list" id="conversationsList">
                    {% for response in responses %}
                    <a href="?response_id={{ response.id }}" class="conversation-item {% if active_response.id == response.id %}active{% endif %}">
                        <div class="conversation-avatar">{{ response.blood_request.hospital.name|slice:":1"|upper }}</div>
                        <div class="conversation-info">
                            <div class="conversation-header">
                                <span class="conversation-name">{{ response.blood_request.hospital.name }}</span>
                                <span class="conversation-time">{{ response.last_message_time|date:"d/m" }}</span>
                            </div>
                            <div class="conversation-preview">
                                <i class="fas fa-tint"></i> {{ response.blood_request.blood_type }} - {{ response.blood_request.quantity }} poche(s)
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <div class="empty-conversations">
                        <i class="fas fa-inbox"></i>
                        <p>Aucune conversation</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Zone de chat -->
            <div class="chat-area">
            {% if active_response %}
            <div class="chat-header">
                <div class="chat-header-avatar">{{ active_response.blood_request.hospital.name|slice:":1"|upper }}</div>
                <div class="chat-header-info">
                    <h3>{{ active_response.blood_request.hospital.name }}</h3>
                    <p><i class="fas fa-tint"></i> {{ active_response.blood_request.blood_type }} - {{ active_response.blood_request.quantity }} poche(s) - <span class="badge-status {{ active_response.status }}">{{ active_response.get_status_display }}</span></p>
                </div>
            </div>
            <div class="messages-area" id="messagesArea">
                {% for message in messages %}
                <div class="message {% if message.sender == request.user %}sent{% endif %}">
                    <div class="message-avatar">{% if message.sender == request.user %}{{ request.user.get_full_name|slice:":1"|upper }}{% else %}{{ active_response.blood_request.hospital.name|slice:":1"|upper }}{% endif %}</div>
                    <div class="message-content">
                        <div class="message-text">{{ message.message }}</div>
                        <div class="message-time">{{ message.timestamp|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="message-input-area">
                <form method="post" class="message-input-form">
                    {% csrf_token %}
                    <input type="hidden" name="response_id" value="{{ active_response.id }}">
                    <textarea name="message" id="messageInput" placeholder="Écrivez votre message..." required></textarea>
                    <button type="submit"><i class="fas fa-paper-plane"></i> Envoyer</button>
                </form>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>Sélectionnez une conversation</h3>
                <p>Choisissez une conversation dans la liste</p>
            </div>
            {% endif %}
        </div>
    </div>
    <script>
        const messagesArea = document.getElementById('messagesArea');
        if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
        const searchInput = document.getElementById('searchInput');
        const conversationsList = document.getElementById('conversationsList');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const conversations = conversationsList.querySelectorAll('.conversation-item');
                conversations.forEach(conv => {
                    const name = conv.querySelector('.conversation-name').textContent.toLowerCase();
                    const preview = conv.querySelector('.conversation-preview');
                    const previewText = preview ? preview.textContent.toLowerCase() : '';
                    if (name.includes(searchTerm) || previewText.includes(searchTerm)) {
                        conv.style.display = 'flex';
                    } else {
                        conv.style.display = 'none';
                    }
                });
            });
        }
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            messageInput.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    this.closest('form').submit();
                }
            });
        }
    </script>
</body>
</html>
