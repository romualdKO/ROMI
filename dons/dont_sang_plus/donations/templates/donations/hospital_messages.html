{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Don de Sang+</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern-design.css' %}">
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <script src="{% static 'js/mobile-menu.js' %}"></script>
</head>
<body>
    {% include 'includes/hospital_sidebar.html' with active_page='messages' %}
    <div class="messages-container">
        <div class="conversations-sidebar">
            <div class="sidebar-header">
                <h2>Messages</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
            </div>
            <div class="conversations-list" id="conversationsList">
                {% for conv in conversations %}
                <a href="?response={{ conv.response.id }}" class="conversation-item {% if active_response and conv.response.id == active_response.id %}active{% endif %}">
                    <div class="conversation-avatar">{{ conv.donor.get_full_name|slice:":1"|upper }}</div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <span class="conversation-name">{{ conv.donor.get_full_name }}</span>
                            {% if conv.last_message %}<span class="conversation-time">{{ conv.last_message.timestamp|timesince }}</span>{% endif %}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="badge-status {{ conv.response.status }}">{{ conv.response.get_status_display }}</span>
                            {% if conv.unread_count > 0 %}<span class="unread-badge">{{ conv.unread_count }}</span>{% endif %}
                        </div>
                        {% if conv.last_message %}<div class="conversation-preview">{{ conv.last_message.message|truncatewords:8 }}</div>{% endif %}
                    </div>
                </a>
                {% empty %}
                <div style="padding: 2rem; text-align: center; color: var(--text-gray);">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>Aucune conversation</p>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="chat-area">
            {% if active_response %}
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="chat-header-avatar">{{ active_response.donor.get_full_name|slice:":1"|upper }}</div>
                    <div class="chat-header-info">
                        <h3>{{ active_response.donor.get_full_name }}</h3>
                        <p><i class="fas fa-tint"></i> {{ active_response.blood_request.blood_type }} - {{ active_response.quantity }} poche(s) - <span class="badge-status {{ active_response.status }}">{{ active_response.get_status_display }}</span></p>
                    </div>
                </div>
                <div class="chat-header-actions">
                    {% if active_response.status == 'pending' %}
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="response_id" value="{{ active_response.id }}">
                        <input type="hidden" name="action" value="approve">
                        <button type="submit" class="btn-action btn-approve"><i class="fas fa-check"></i> Approuver</button>
                    </form>
                    {% elif active_response.status == 'approved' %}
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="response_id" value="{{ active_response.id }}">
                        <input type="hidden" name="action" value="complete">
                        <button type="submit" class="btn-action btn-complete"><i class="fas fa-check-double"></i> Compléter</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="messages-area" id="messagesArea">
                {% for message in messages %}
                <div class="message {% if message.sender == request.user %}sent{% endif %}">
                    <div class="message-avatar">{% if message.sender == request.user %}{{ request.user.name|slice:":1"|upper }}{% else %}{{ active_response.donor.get_full_name|slice:":1"|upper }}{% endif %}</div>
                    <div class="message-content">
                        <div class="message-text">{{ message.message }}</div>
                        <div class="message-time">{{ message.timestamp|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="message-input-area">
                <form method="post" class="message-input-form">
                    {% csrf_token %}
                    <input type="hidden" name="response_id" value="{{ active_response.id }}">
                    <textarea name="message" id="messageInput" placeholder="Écrivez votre message..." required></textarea>
                    <button type="submit"><i class="fas fa-paper-plane"></i> Envoyer</button>
                </form>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>Sélectionnez une conversation</h3>
                <p>Choisissez une conversation dans la liste</p>
            </div>
            {% endif %}
        </div>
    </div>
    <script>
        const messagesArea = document.getElementById('messagesArea');
        if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
        const searchInput = document.getElementById('searchInput');
        const conversationsList = document.getElementById('conversationsList');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const conversations = conversationsList.querySelectorAll('.conversation-item');
                conversations.forEach(conv => {
                    const name = conv.querySelector('.conversation-name').textContent.toLowerCase();
                    const preview = conv.querySelector('.conversation-preview');
                    const previewText = preview ? preview.textContent.toLowerCase() : '';
                    if (name.includes(searchTerm) || previewText.includes(searchTerm)) {
                        conv.style.display = 'flex';
                    } else {
                        conv.style.display = 'none';
                    }
                });
            });
        }
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            messageInput.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    this.closest('form').submit();
                }
            });
        }
    </script>
</body>
</html>
