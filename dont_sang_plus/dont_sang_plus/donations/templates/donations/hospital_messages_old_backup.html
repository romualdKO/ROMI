<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - Don Sang Plus</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/modern-design.css' %}">
</head>
<body>
    <!-- Sidebar -->
    <div class="modern-sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon">
                <i class="fas fa-heart-pulse"></i>
            </div>
            <div class="sidebar-logo-text">Don Sang Plus</div>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'donations:hospital_dashboard' %}" class="sidebar-nav-item">
                <i class="fas fa-home sidebar-nav-icon"></i>
                Dashboard
            </a>
            <a href="{% url 'donations:hospital_dashboard' %}#requests-section" class="sidebar-nav-item">
                <i class="fas fa-clipboard-list sidebar-nav-icon"></i>
                Demandes
            </a>
            <a href="{% url 'donations:hospital_messages' %}" class="sidebar-nav-item active">
                <i class="fas fa-envelope sidebar-nav-icon"></i>
                Messages
                {% if unread_count > 0 %}
                <span class="notification-badge">{{ unread_count }}</span>
                {% endif %}
            </a>
            <a href="{% url 'donations:hospital_history' %}" class="sidebar-nav-item">
                <i class="fas fa-history sidebar-nav-icon"></i>
                Historique
            </a>
            <a href="{% url 'donations:hospital_dashboard' %}#donors-section" class="sidebar-nav-item">
                <i class="fas fa-users sidebar-nav-icon"></i>
                Donneurs
            </a>
            <a href="{% url 'donations:edit_profile' %}" class="sidebar-nav-item">
                <i class="fas fa-cog sidebar-nav-icon"></i>
                Paramètres
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{% url 'accounts:logout' %}" class="sidebar-nav-item" style="color: var(--danger-red);">
                <i class="fas fa-sign-out-alt sidebar-nav-icon"></i>
                Déconnexion
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="modern-main-content">
        <div class="modern-topbar">
            <div>
                <div class="topbar-title">
                    <i class="fas fa-envelope"></i> Messagerie
                </div>
                <div class="topbar-subtitle">{{ total_conversations }} conversation(s) • {{ unread_count }} non lu(s)</div>
            </div>
            <div class="topbar-actions">
                <a href="{% url 'donations:hospital_dashboard' %}" class="btn-modern-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <div class="container-modern">
            {% if conversations %}
                <div class="row g-4">
                    {% for conv in conversations %}
                        <div class="col-md-6">
                            <a href="{% url 'donations:chat_with_donor' conv.response.id %}" style="text-decoration: none;">
                                <div class="card-modern" style="transition: all 0.3s ease; cursor: pointer; {% if conv.unread_count > 0 %}border-left: 4px solid var(--danger-red);{% endif %}">
                                    <div class="card-modern-body">
                                        <div style="display: flex; gap: 16px; align-items: start;">
                                            <!-- Avatar Donor -->
                                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--success-green), #10B981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; flex-shrink: 0;">
                                                {{ conv.response.donor.first_name.0|default:"D" }}{{ conv.response.donor.last_name.0|default:"" }}
                                            </div>
                                            
                                            <div style="flex: 1; min-width: 0;">
                                                <!-- Donor Name -->
                                                <h5 style="color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">
                                                    {{ conv.response.donor.get_full_name }}
                                                </h5>
                                                
                                                <!-- Blood Type & Status -->
                                                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                                                    <span class="badge-modern danger">
                                                        <i class="fas fa-tint"></i> {{ conv.blood_request.blood_type }}
                                                    </span>
                                                    {% if conv.response.status == 'pending' %}
                                                        <span class="badge-modern warning">En attente</span>
                                                    {% elif conv.response.status == 'accepted' %}
                                                        <span class="badge-modern success">Accepté</span>
                                                    {% elif conv.response.status == 'completed' %}
                                                        <span class="badge-modern info">Complété</span>
                                                    {% endif %}
                                                    {% if conv.unread_count > 0 %}
                                                        <span class="badge-modern danger">
                                                            {{ conv.unread_count }} nouveau(x)
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Last Message -->
                                                <div style="background: var(--secondary-gray); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                                    <div style="color: var(--text-gray); font-size: 14px; line-height: 1.5;">
                                                        <strong>{{ conv.last_message.sender.get_full_name }}:</strong>
                                                        {{ conv.last_message.message|truncatewords:10 }}
                                                    </div>
                                                </div>
                                                
                                                <!-- Footer -->
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 13px; color: var(--text-gray);">
                                                        <i class="far fa-clock"></i> {{ conv.last_message.timestamp|timesince }}
                                                    </span>
                                                    <span style="font-size: 13px; color: var(--text-gray);">
                                                        <i class="fas fa-phone"></i> {{ conv.response.donor.phone }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="card-modern">
                    <div class="card-modern-body" style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-envelope-open" style="font-size: 64px; color: var(--text-gray); margin-bottom: 20px;"></i>
                        <h4 style="color: var(--text-dark); margin-bottom: 12px;">Aucun message</h4>
                        <p style="color: var(--text-gray);">
                            Vous n'avez pas encore reçu de réponses de donneurs. Créez une demande de sang pour commencer.
                        </p>
                        <a href="{% url 'donations:create_blood_request' %}" class="btn-modern-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Créer une demande
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
