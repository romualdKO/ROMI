{% extends 'base.html' %}
{% load static %}

{% block title %}Modifier mon profil - Don Sang Plus{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        Modifier mon profil
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Messages -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- ✅ CORRIGE L'ACTION DU FORMULAIRE -->
                    <form method="post" enctype="multipart/form-data" action="/donations/edit-profile/">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Photo de profil -->
                            <div class="col-md-4 text-center mb-4">
                                <div class="mb-3">
                                    {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" 
                                             alt="Photo de profil" 
                                             class="rounded-circle border border-3 border-primary" 
                                             width="150" height="150" 
                                             style="object-fit: cover;">
                                    {% else %}
                                        <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center border border-3" 
                                             style="width: 150px; height: 150px;">
                                            <span class="text-white fs-1">
                                                {{ user.get_full_name|first|upper|default:"?" }}
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <label for="id_profile_picture" class="form-label fw-bold">
                                        <i class="fas fa-camera me-2"></i>
                                        Changer la photo
                                    </label>
                                    <input type="file" 
                                           class="form-control" 
                                           id="id_profile_picture" 
                                           name="profile_picture" 
                                           accept="image/*">
                                    <div class="form-text">JPG, PNG, GIF (max 5MB)</div>
                                </div>
                            </div>
                            
                            <!-- Informations personnelles -->
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_first_name" class="form-label fw-bold">
                                            <i class="fas fa-user me-2"></i>Prénom *
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="id_first_name" 
                                               name="first_name" 
                                               value="{{ form.first_name.value|default:user.first_name }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_last_name" class="form-label fw-bold">
                                            <i class="fas fa-user me-2"></i>Nom *
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="id_last_name" 
                                               name="last_name" 
                                               value="{{ form.last_name.value|default:user.last_name }}"
                                               required>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_email" class="form-label fw-bold">
                                            <i class="fas fa-envelope me-2"></i>Email *
                                        </label>
                                        <input type="email" 
                                               class="form-control" 
                                               id="id_email" 
                                               name="email" 
                                               value="{{ form.email.value|default:user.email }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_phone" class="form-label fw-bold">
                                            <i class="fas fa-phone me-2"></i>Téléphone *
                                        </label>
                                        <input type="tel" 
                                               class="form-control" 
                                               id="id_phone" 
                                               name="phone" 
                                               value="{{ form.phone.value|default:user.phone }}"
                                               placeholder="+225 XX XX XX XX XX"
                                               required>
                                    </div>
                                </div>
                                
                                {% if user.user_type == 'donor' %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="id_blood_type" class="form-label fw-bold">
                                            <i class="fas fa-tint me-2 text-danger"></i>Groupe sanguin *
                                        </label>
                                        <select class="form-select" id="id_blood_type" name="blood_type" required>
                                            <option value="">Sélectionnez votre groupe...</option>
                                            <option value="A+" {% if user.blood_type == 'A+' %}selected{% endif %}>A+</option>
                                            <option value="A-" {% if user.blood_type == 'A-' %}selected{% endif %}>A-</option>
                                            <option value="B+" {% if user.blood_type == 'B+' %}selected{% endif %}>B+</option>
                                            <option value="B-" {% if user.blood_type == 'B-' %}selected{% endif %}>B-</option>
                                            <option value="AB+" {% if user.blood_type == 'AB+' %}selected{% endif %}>AB+</option>
                                            <option value="AB-" {% if user.blood_type == 'AB-' %}selected{% endif %}>AB-</option>
                                            <option value="O+" {% if user.blood_type == 'O+' %}selected{% endif %}>O+</option>
                                            <option value="O-" {% if user.blood_type == 'O-' %}selected{% endif %}>O-</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="id_birth_date" class="form-label fw-bold">
                                            <i class="fas fa-birthday-cake me-2"></i>Date de naissance *
                                        </label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="id_birth_date" 
                                               name="birth_date" 
                                               value="{{ user.birth_date|date:'Y-m-d' }}"
                                               required>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_city" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt me-2"></i>Ville *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="id_city" 
                                       name="city" 
                                       value="{{ form.city.value|default:user.city }}"
                                       required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_address" class="form-label fw-bold">
                                    <i class="fas fa-home me-2"></i>Adresse
                                </label>
                                <textarea class="form-control" 
                                          id="id_address" 
                                          name="address" 
                                          rows="2"
                                          placeholder="Votre adresse complète...">{{ form.address.value|default:user.address }}</textarea>
                            </div>
                        </div>
                        
                        {% if user.user_type == 'donor' %}
                        <div class="mb-3">
                            <label for="id_medical_history" class="form-label fw-bold">
                                <i class="fas fa-notes-medical me-2"></i>Antécédents médicaux
                            </label>
                            <textarea class="form-control" 
                                      id="id_medical_history" 
                                      name="medical_history" 
                                      rows="4" 
                                      placeholder="Allergies, conditions médicales, traitements en cours, dernière donation...">{{ form.medical_history.value|default:user.medical_history }}</textarea>
                            <div class="form-text">
                                <i class="fas fa-shield-alt me-1"></i>
                                Informations confidentielles importantes pour votre sécurité et celle des receveurs
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <!-- ✅ CORRIGE LES LIENS DE RETOUR SELON LE TYPE D'UTILISATEUR -->
                            {% if user.user_type == 'donor' %}
                                <a href="/donations/donor-dashboard/" class="btn btn-outline-secondary me-md-2">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Retour au tableau de bord
                                </a>
                            {% else %}
                                <a href="/donations/hospital-dashboard/" class="btn btn-outline-secondary me-md-2">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Retour au tableau de bord
                                </a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .form-control, .form-select {
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .card {
        border: none;
        border-radius: 15px;
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
    }
</style>
{% endblock %}